services:
  rdf-align-runner:
    build: ./
    environment:
      URL: "https://pod.rubendedecker.be/scholar/projects/deployEMDS/data/458f6bd4-b2ef-47b8-9d02-156502ac80ce"
      Query: |-
        PREFIX rdf:    <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX xsd:    <http://www.w3.org/2001/XMLSchema#>

        PREFIX sosa:   <http://www.w3.org/ns/sosa/>
        PREFIX ssn:    <http://www.w3.org/ns/ssn/>
        PREFIX geo:    <http://www.w3.org/2003/01/geo/wgs84_pos#>

        PREFIX prov:   <http://www.w3.org/ns/prov#>
        PREFIX terms:  <http://purl.org/dc/terms/>
        PREFIX time:   <http://www.w3.org/2006/time#>

        PREFIX geosparql: <http://www.opengis.net/ont/geosparql#>
        PREFIX sf:        <http://www.opengis.net/ont/sf#>

        PREFIX verkeersmetingen: <https://data.vlaanderen.be/ns/verkeersmetingen#>
        PREFIX weg:             <https://data.vlaanderen.be/ns/weg#>
        PREFIX netwerk:         <https://data.vlaanderen.be/ns/netwerk#>
        PREFIX vsds:            <https://implementatie.data.vlaanderen.be/ns/vsds-verkeersmetingen#>

        PREFIX LinkDirectionValue: <https://inspire.ec.europa.eu/codelist/LinkDirectionValue/>
        PREFIX MeasureTypes:       <http://def.isotc211.org/iso19103/2015/MeasureTypes#>
        PREFIX schema:             <https://schema.org/>

        # Alignment: sosa:Observation (+ WGS84 location FOI) -> vsds:Verkeerstelling
        # Notes:
        # - The nested structures are minted as deterministic blank nodes (BNODE with stable labels).
        # - Where your input has no equivalent (sensor type, voertuigType, kenmerktype, etc.),
        #   fixed IRIs are used; replace them with your preferred controlled vocabularies.
        # - phenomenonTime is turned into a time:TemporalEntity with a default duration PT1M.

        CONSTRUCT {
          ?vobs
              rdf:type vsds:Verkeerstelling ;
              <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.phenomenonTime> ?tempEnt ;
              terms:isVersionOf ?baseObs ;
              prov:generatedAtTime ?genTime ;
              sosa:madeBySensor ?sensor ;
              verkeersmetingen:geobserveerdObject ?meetpunt ;
              vsds:Verkeerstelling.geobserveerdKenmerk ?kenmerk ;
              vsds:Verkeerstelling.tellingresultaat ?count .

          ?tempEnt
              rdf:type time:TemporalEntity ;
              time:hasBeginning ?instant ;
              time:hasXSDDuration "PT1M"^^xsd:duration .

          ?instant
              rdf:type time:Instant ;
              time:inXSDDateTimeStamp ?phenTime .

          ?sensor
              rdf:type sosa:Sensor ;
              terms:type <https://example.org/id/sensorType/unknown> .

          ?meetpunt
              rdf:type verkeersmetingen:Verkeersmeetpunt ;
              <http://def.isotc211.org/iso19156/2011/SamplingPoint#SF_SamplingPoint.shape> ?point ;
              verkeersmetingen:bemonsterdObject ?rijrichting ;
              vsds:Verkeersmeetpunt.verkeersmeetpuntnetwerkreferentie ?puntref .

          ?point
              rdf:type sf:Point ;
              geosparql:asWKT ?wktPoint .

          ?rijrichting
              rdf:type weg:Rijrichting ;
              weg:rijrichting LinkDirectionValue:inDirection ;
              vsds:Rijrichting.netwerkreferentieelement ?wegsegment .

          ?wegsegment
              rdf:type weg:Wegsegment ;
              netwerk:Link.geometriemiddellijn ?line ;
              netwerk:beginknoop ?begknoop ;
              netwerk:eindknoop ?eindknoop .

          ?line
              rdf:type sf:LineString ;
              geosparql:asWKT ?wktLine .

          ?begknoop
              rdf:type weg:Wegknoop ;
              netwerk:Knoop.geometrie ?begPoint .

          ?eindknoop
              rdf:type weg:Wegknoop ;
              netwerk:Knoop.geometrie ?endPoint .

          ?begPoint
              rdf:type sf:Point ;
              geosparql:asWKT ?wktPoint .

          ?endPoint
              rdf:type sf:Point ;
              geosparql:asWKT ?wktPoint .

          ?puntref
              rdf:type netwerk:Puntreferentie ;
              netwerk:Puntreferentie.opPositie ?len ;
              netwerk:toepassingsRichting LinkDirectionValue:bothDirection .

          ?len
              rdf:type MeasureTypes:Length ;
              schema:unitCode "m"^^<https://w3id.org/cdt/ucumunit> ;
              schema:value 0.0e0 .

          ?kenmerk
              rdf:type vsds:Verkeerstellingkenmerk ;
              verkeersmetingen:voertuigType <https://example.org/id/voertuigType/unknown> ;
              vsds:Verkeerstellingkenmerk.kenmerktype <https://data.vlaanderen.be/doc/concept/VkmVerkeersKenmerkType/aantal> .
        }
        WHERE {
          ?obs rdf:type sosa:Observation ;
              sosa:phenomenonTime ?phenTime ;
              sosa:resultTime ?genTime ;
              sosa:hasSimpleResult ?count ;
              sosa:hasFeatureOfInterest ?loc .

          # pick the FOI that is a location feature with WGS84 lat/long
          ?loc rdf:type ssn:SpatialObject ;
              geo:lat ?lat ;
              geo:long ?long .

          # Target observation IRI:
          # - here we keep the original ?obs IRI, but you can mint a new one if you prefer
          BIND(?obs AS ?vobs)

          # isVersionOf: drop the last path segment
          BIND( IRI(REPLACE(STR(?vobs), "/[^/]*$", "")) AS ?baseObs )

          # Geometry literals (WKT uses "lon lat")
          BIND( STRDT(CONCAT("POINT (", STR(?long), " ", STR(?lat), ")"), geosparql:wktLiteral) AS ?wktPoint )
          BIND( STRDT(CONCAT("LINESTRING (",
                              STR(?long), " ", STR(?lat), ", ",
                              STR(?long), " ", STR(?lat),
                              ")"), geosparql:wktLiteral) AS ?wktLine )

          # Deterministic blank nodes (stable IDs per observation)
          BIND( BNODE(CONCAT("temp-", SHA1(STR(?vobs)))) AS ?tempEnt )
          BIND( BNODE(CONCAT("inst-", SHA1(STR(?vobs)))) AS ?instant )
          BIND( BNODE(CONCAT("sens-", SHA1(STR(?vobs)))) AS ?sensor )
          BIND( BNODE(CONCAT("mp-",   SHA1(STR(?vobs)))) AS ?meetpunt )
          BIND( BNODE(CONCAT("pt-",   SHA1(STR(?vobs)))) AS ?point )
          BIND( BNODE(CONCAT("rr-",   SHA1(STR(?vobs)))) AS ?rijrichting )
          BIND( BNODE(CONCAT("ws-",   SHA1(STR(?vobs)))) AS ?wegsegment )
          BIND( BNODE(CONCAT("ls-",   SHA1(STR(?vobs)))) AS ?line )
          BIND( BNODE(CONCAT("bk-",   SHA1(STR(?vobs)))) AS ?begknoop )
          BIND( BNODE(CONCAT("ek-",   SHA1(STR(?vobs)))) AS ?eindknoop )
          BIND( BNODE(CONCAT("bp-",   SHA1(STR(?vobs)))) AS ?begPoint )
          BIND( BNODE(CONCAT("ep-",   SHA1(STR(?vobs)))) AS ?endPoint )
          BIND( BNODE(CONCAT("pr-",   SHA1(STR(?vobs)))) AS ?puntref )
          BIND( BNODE(CONCAT("len-",  SHA1(STR(?vobs)))) AS ?len )
          BIND( BNODE(CONCAT("ken-",  SHA1(STR(?vobs)))) AS ?kenmerk )
        }        
        
      STORE: "http://host.docker.internal:7878/store?default"
      # METHOD: "PUT"   # default is PUT; set to POST to append
    restart: "no"
